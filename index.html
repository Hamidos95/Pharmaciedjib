<!DOCTYPE html>
<html>
<head>
  <title>Pharmacies de Garde à Djibouti-Ville</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map {
      height: 600px;
      width: 100%;
      margin-top: 10px;
    }
    h1 {
      text-align: center;
      font-family: Arial, sans-serif;
    }
    #pharmacy-list {
      margin-top: 20px;
      padding: 10px;
      background: #f4f4f4;
      border-radius: 5px;
    }
    #pharmacy-list ul {
      list-style-type: none;
      padding: 0;
    }
    #pharmacy-list li {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <h1>Pharmacies de Garde à Djibouti-Ville</h1>
  <div id="map"></div>
  <div id="pharmacy-list">
    <h2>Liste des pharmacies</h2>
    <ul id="pharmacies"></ul>
  </div>
  <script>
    // Coordonnées du centre de Djibouti-Ville
    const djiboutiCenter = [11.5880, 43.1450];

    // Création de la carte
    const map = L.map('map').setView(djiboutiCenter, 13);

    // Ajout de la carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Liste des pharmacies de Djibouti-Ville (nom, coordonnées, statut de garde)
    const pharmacies = [
      { name: "Pharmacie du Centre", lat: 11.5890, lng: 43.1460, isOnDuty: true },
      { name: "Pharmacie de la Paix", lat: 11.5870, lng: 43.1440, isOnDuty: false },
      { name: "Pharmacie de l'Espoir", lat: 11.5900, lng: 43.1470, isOnDuty: true },
      { name: "Pharmacie du Marché", lat: 11.5860, lng: 43.1430, isOnDuty: false },
      { name: "Pharmacie de la Gare", lat: 11.5910, lng: 43.1480, isOnDuty: true },
      // Ajoutez d'autres pharmacies ici avec leurs vraies coordonnées
    ];

    // Icônes personnalisées
    const greenIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-green.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
    });

    const redIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
    });

    const blueIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-blue.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
    });

    const goldIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-gold.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
    });

    // Fonction pour calculer la distance et le temps avec OpenRouteService
    async function calculateDistanceAndTime(start, end) {
      const url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=5b3ce3597851110001cf6248e2a8d8a24b7a4f9b8b6f4f4f4f4f4f4f4f4f4f4&start=${start[1]},${start[0]}&end=${end[1]},${end[0]}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.features && data.features.length > 0) {
        const distance = data.features[0].properties.segments[0].distance / 1000; // Distance en km
        const duration = data.features[0].properties.segments[0].duration / 60; // Temps en minutes
        return { distance: distance.toFixed(2), duration: duration.toFixed(2) };
      }
      return null;
    }

    // Affichage des pharmacies sur la carte
    pharmacies.forEach(pharma => {
      L.marker([pharma.lat, pharma.lng], {
        title: pharma.name,
        icon: pharma.isOnDuty ? greenIcon : redIcon, // Pharmacie de garde (vert), autres (rouge)
      }).addTo(map).bindPopup(pharma.name);
    });

    // Géolocalisation de l'utilisateur et calcul de la pharmacie la plus proche
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async position => {
        const userLocation = [position.coords.latitude, position.coords.longitude];

        // Ajouter un marqueur pour la position de l'utilisateur
        L.marker(userLocation, {
          icon: blueIcon,
        }).addTo(map).bindPopup('Votre position').openPopup();

        // Calculer la pharmacie la plus proche
        let nearestPharmacy = null;
        let nearestDistance = Infinity;
        let nearestDuration = Infinity;

        const pharmacyList = document.getElementById('pharmacies');
        pharmacyList.innerHTML = ''; // Vider la liste avant de la remplir

        for (const pharma of pharmacies) {
          const result = await calculateDistanceAndTime(userLocation, [pharma.lat, pharma.lng]);
          if (result) {
            const { distance, duration } = result;
            if (distance < nearestDistance) {
              nearestDistance = distance;
              nearestDuration = duration;
              nearestPharmacy = pharma;
            }

            // Ajouter la pharmacie à la liste
            const li = document.createElement('li');
            li.innerHTML = `<b>${pharma.name}</b><br>Distance: ${distance} km<br>Temps: ${duration} min`;
            pharmacyList.appendChild(li);
          }
        }

        // Afficher la pharmacie la plus proche avec une icône spéciale
        if (nearestPharmacy) {
          L.marker([nearestPharmacy.lat, nearestPharmacy.lng], {
            icon: goldIcon,
          }).addTo(map).bindPopup(`<b>${nearestPharmacy.name}</b><br>Distance: ${nearestDistance} km<br>Temps: ${nearestDuration} min`).openPopup();
        }

        // Centrer la carte sur la position de l'utilisateur
        map.setView(userLocation, 15);
      });
    }
  </script>
</body>
</html>
